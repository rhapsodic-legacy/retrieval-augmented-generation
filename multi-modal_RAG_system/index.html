<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Modal RAG</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .content-card { @apply bg-white rounded-lg shadow-md p-4 mb-4; }
        .type-badge { @apply px-2 py-1 text-xs rounded-full font-medium; }
        .type-text { @apply bg-blue-100 text-blue-800; }
        .type-image { @apply bg-green-100 text-green-800; }
        .type-table { @apply bg-purple-100 text-purple-800; }
        .type-chart { @apply bg-orange-100 text-orange-800; }
        
        .drop-zone {
            @apply border-2 border-dashed border-gray-300 rounded-lg p-8 text-center;
            transition: all 0.3s ease;
        }
        .drop-zone.active { @apply border-blue-500 bg-blue-50; }
        
        .image-preview { max-height: 200px; object-fit: contain; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const API_BASE = '';
        
        const api = {
            async init(config) {
                const res = await fetch(`${API_BASE}/api/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });
                return res.json();
            },
            
            async getStatus() {
                const res = await fetch(`${API_BASE}/api/status`);
                return res.json();
            },
            
            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData,
                });
                return res.json();
            },
            
            async query(question, k = 5) {
                const res = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, k, include_images: true }),
                });
                return res.json();
            },
            
            async getSources() {
                const res = await fetch(`${API_BASE}/api/sources`);
                return res.json();
            },
            
            getImageUrl(imageId) {
                return `${API_BASE}/api/image/${imageId}`;
            },
        };
        
        function Header({ status }) {
            return (
                <header className="bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg">
                    <div className="container mx-auto px-4 py-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-3xl font-bold">üñºÔ∏è Multi-Modal RAG</h1>
                                <p className="text-purple-100 mt-1">
                                    Text + Images + PDFs + Tables in one search
                                </p>
                            </div>
                            <div className={`px-3 py-1 rounded-full text-sm ${
                                status === 'ready' ? 'bg-green-500' : 'bg-yellow-500'
                            }`}>
                                {status === 'ready' ? '‚óè Ready' : '‚óã Not Initialized'}
                            </div>
                        </div>
                    </div>
                </header>
            );
        }
        
        function ConfigPanel({ onInit }) {
            const [config, setConfig] = useState({
                llm_provider: 'anthropic',
                embedding_provider: 'local',
                n_results: 5,
            });
            const [loading, setLoading] = useState(false);
            
            const handleInit = async () => {
                setLoading(true);
                try {
                    await api.init(config);
                    onInit();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                LLM Provider (with Vision)
                            </label>
                            <select
                                value={config.llm_provider}
                                onChange={e => setConfig({...config, llm_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                                <option value="openai">OpenAI (GPT-4o)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Embedding Provider
                            </label>
                            <select
                                value={config.embedding_provider}
                                onChange={e => setConfig({...config, embedding_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="local">Local (Testing)</option>
                                <option value="voyage">Voyage AI</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        
                        <button
                            onClick={handleInit}
                            disabled={loading}
                            className="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 disabled:bg-gray-400"
                        >
                            {loading ? 'Initializing...' : 'Initialize System'}
                        </button>
                    </div>
                </div>
            );
        }
        
        function UploadPanel({ onUpload }) {
            const [isDragging, setIsDragging] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [uploads, setUploads] = useState([]);
            const fileInputRef = useRef(null);
            
            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };
            
            const handleDragLeave = () => setIsDragging(false);
            
            const handleDrop = async (e) => {
                e.preventDefault();
                setIsDragging(false);
                
                const files = Array.from(e.dataTransfer.files);
                await uploadFiles(files);
            };
            
            const handleFileSelect = async (e) => {
                const files = Array.from(e.target.files);
                await uploadFiles(files);
            };
            
            const uploadFiles = async (files) => {
                setUploading(true);
                
                for (const file of files) {
                    try {
                        const result = await api.uploadFile(file);
                        setUploads(prev => [...prev, {
                            name: file.name,
                            status: 'success',
                            stats: result.stats,
                        }]);
                        onUpload();
                    } catch (err) {
                        setUploads(prev => [...prev, {
                            name: file.name,
                            status: 'error',
                            error: err.message,
                        }]);
                    }
                }
                
                setUploading(false);
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-semibold mb-4">üì§ Upload Content</h2>
                    
                    <div
                        className={`drop-zone ${isDragging ? 'active' : ''}`}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        onClick={() => fileInputRef.current?.click()}
                    >
                        <input
                            type="file"
                            ref={fileInputRef}
                            onChange={handleFileSelect}
                            multiple
                            accept=".pdf,.png,.jpg,.jpeg,.csv,.xlsx,.xls,.txt,.md,.html"
                            className="hidden"
                        />
                        
                        <div className="text-4xl mb-2">üìÅ</div>
                        <p className="text-gray-600">
                            {uploading ? 'Uploading...' : 'Drop files here or click to upload'}
                        </p>
                        <p className="text-sm text-gray-400 mt-1">
                            PDF, Images, CSV, Excel, Text, HTML
                        </p>
                    </div>
                    
                    {uploads.length > 0 && (
                        <div className="mt-4 space-y-2">
                            {uploads.slice(-5).map((upload, i) => (
                                <div key={i} className={`text-sm p-2 rounded ${
                                    upload.status === 'success' ? 'bg-green-50' : 'bg-red-50'
                                }`}>
                                    <span className="font-medium">{upload.name}</span>
                                    {upload.stats && (
                                        <span className="text-gray-500 ml-2">
                                            {Object.entries(upload.stats).map(([k, v]) => `${k}: ${v}`).join(', ')}
                                        </span>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        function ResultCard({ result, type }) {
            const [showImage, setShowImage] = useState(false);
            
            const typeColors = {
                text: 'type-text',
                image: 'type-image',
                table: 'type-table',
                chart: 'type-chart',
            };
            
            return (
                <div className="content-card">
                    <div className="flex items-start justify-between mb-2">
                        <span className={`type-badge ${typeColors[type] || 'bg-gray-100'}`}>
                            {type === 'image' && 'üñºÔ∏è '}
                            {type === 'table' && 'üìä '}
                            {type === 'text' && 'üìù '}
                            {type}
                        </span>
                        <span className="text-sm text-gray-500">
                            Score: {result.score?.toFixed(3)}
                        </span>
                    </div>
                    
                    <p className="text-gray-600 text-sm mb-2">
                        {result.description || result.text}
                    </p>
                    
                    <div className="text-xs text-gray-400">
                        Source: {result.source}
                    </div>
                    
                    {type === 'image' && result.has_data && (
                        <div className="mt-2">
                            <button
                                onClick={() => setShowImage(!showImage)}
                                className="text-blue-600 text-sm hover:underline"
                            >
                                {showImage ? 'Hide Image' : 'Show Image'}
                            </button>
                            {showImage && (
                                <img
                                    src={api.getImageUrl(result.id)}
                                    alt="Result"
                                    className="mt-2 image-preview rounded"
                                />
                            )}
                        </div>
                    )}
                    
                    {type === 'table' && (
                        <div className="mt-2 text-sm text-gray-600">
                            <span className="font-medium">{result.num_rows} rows</span>
                            <span className="mx-2">‚Ä¢</span>
                            <span>Columns: {result.columns?.join(', ')}</span>
                        </div>
                    )}
                </div>
            );
        }
        
        function QueryPanel({ status }) {
            const [query, setQuery] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const handleQuery = async () => {
                if (!query || status !== 'ready') return;
                
                setLoading(true);
                try {
                    const data = await api.query(query);
                    setResult(data);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-semibold mb-4">üîç Query</h2>
                        
                        <div className="flex space-x-3">
                            <input
                                type="text"
                                placeholder="Find the chart showing Q3 revenue..."
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleQuery()}
                                className="flex-1 border rounded-md px-4 py-2"
                            />
                            <button
                                onClick={handleQuery}
                                disabled={loading || status !== 'ready'}
                                className="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 disabled:bg-gray-400"
                            >
                                {loading ? '...' : 'Search'}
                            </button>
                        </div>
                    </div>
                    
                    {result && (
                        <div className="space-y-4">
                            <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h3 className="font-medium text-purple-900 mb-2">Answer</h3>
                                <div className="text-gray-800 whitespace-pre-wrap">
                                    {result.answer}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <h3 className="font-semibold mb-2">
                                        üìù Text ({result.text_results?.length || 0})
                                    </h3>
                                    {result.text_results?.map((r, i) => (
                                        <ResultCard key={i} result={r} type="text" />
                                    ))}
                                </div>
                                
                                <div>
                                    <h3 className="font-semibold mb-2">
                                        üñºÔ∏è Images ({result.image_results?.length || 0})
                                    </h3>
                                    {result.image_results?.map((r, i) => (
                                        <ResultCard key={i} result={r} type="image" />
                                    ))}
                                </div>
                                
                                <div>
                                    <h3 className="font-semibold mb-2">
                                        üìä Tables ({result.table_results?.length || 0})
                                    </h3>
                                    {result.table_results?.map((r, i) => (
                                        <ResultCard key={i} result={r} type="table" />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        function App() {
            const [status, setStatus] = useState('not_initialized');
            
            const checkStatus = async () => {
                try {
                    const data = await api.getStatus();
                    setStatus(data.status);
                } catch (err) {
                    console.error(err);
                }
            };
            
            useEffect(() => {
                checkStatus();
            }, []);
            
            return (
                <div className="min-h-screen">
                    <Header status={status} />
                    
                    <main className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-6">
                                <ConfigPanel onInit={checkStatus} />
                                <UploadPanel onUpload={checkStatus} />
                            </div>
                            
                            <div className="lg:col-span-2">
                                <QueryPanel status={status} />
                            </div>
                        </div>
                    </main>
                    
                    <footer className="bg-gray-100 py-4 mt-8">
                        <div className="container mx-auto px-4 text-center text-gray-600 text-sm">
                            Multi-Modal RAG ‚Ä¢ Text + Images + PDFs + Tables
                        </div>
                    </footer>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
