<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code RAG - Intelligent Codebase Q&A</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        .code-block { background: #1e1e1e; border-radius: 8px; overflow: hidden; }
        .code-block pre { margin: 0; padding: 1rem; overflow-x: auto; }
        .code-block code { font-family: 'Fira Code', monospace; font-size: 13px; }
        
        #graph-container { width: 100%; height: 500px; border: 1px solid #e5e7eb; border-radius: 8px; }
        
        .file-tree { font-family: monospace; font-size: 13px; }
        .file-tree-item { padding: 2px 8px; cursor: pointer; }
        .file-tree-item:hover { background: #f3f4f6; }
        
        .symbol-badge { @apply px-2 py-0.5 text-xs rounded font-medium; }
        .symbol-function { @apply bg-blue-100 text-blue-800; }
        .symbol-class { @apply bg-purple-100 text-purple-800; }
        .symbol-method { @apply bg-green-100 text-green-800; }
        
        .flow-step { @apply border-l-4 border-blue-500 pl-4 py-2 mb-2; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const API_BASE = '';
        
        // =================================================================
        // API Functions
        // =================================================================
        
        const api = {
            async init(config) {
                const res = await fetch(`${API_BASE}/api/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });
                return res.json();
            },
            
            async getStatus() {
                const res = await fetch(`${API_BASE}/api/status`);
                return res.json();
            },
            
            async indexDirectory(path) {
                const res = await fetch(`${API_BASE}/api/index/directory?path=${encodeURIComponent(path)}`, {
                    method: 'POST',
                });
                return res.json();
            },
            
            async query(question, k = 10) {
                const res = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, k }),
                });
                return res.json();
            },
            
            async traceFlow(start, end) {
                const res = await fetch(`${API_BASE}/api/trace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start, end }),
                });
                return res.json();
            },
            
            async findSymbol(name) {
                const res = await fetch(`${API_BASE}/api/symbol/find`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                return res.json();
            },
            
            async getCallers(name) {
                const res = await fetch(`${API_BASE}/api/symbol/callers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                return res.json();
            },
            
            async getGraph() {
                const res = await fetch(`${API_BASE}/api/graph`);
                return res.json();
            },
        };
        
        // =================================================================
        // Components
        // =================================================================
        
        function Header({ status }) {
            return (
                <header className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
                    <div className="container mx-auto px-4 py-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-3xl font-bold">üíª Code RAG</h1>
                                <p className="text-indigo-100 mt-1">
                                    Intelligent Q&A over codebases with AST-aware analysis
                                </p>
                            </div>
                            <div className={`px-3 py-1 rounded-full text-sm ${
                                status === 'ready' ? 'bg-green-500' : 'bg-yellow-500'
                            }`}>
                                {status === 'ready' ? '‚óè Ready' : '‚óã Not Initialized'}
                            </div>
                        </div>
                    </div>
                </header>
            );
        }
        
        function ConfigPanel({ onInit }) {
            const [config, setConfig] = useState({
                llm_provider: 'anthropic',
                embedding_provider: 'local',
                n_results: 10,
            });
            const [dirPath, setDirPath] = useState('');
            const [loading, setLoading] = useState(false);
            const [indexStats, setIndexStats] = useState(null);
            
            const handleInit = async () => {
                setLoading(true);
                try {
                    await api.init(config);
                    onInit();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            const handleIndex = async () => {
                if (!dirPath) return;
                setLoading(true);
                try {
                    const stats = await api.indexDirectory(dirPath);
                    setIndexStats(stats);
                    onInit();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                LLM Provider
                            </label>
                            <select
                                value={config.llm_provider}
                                onChange={e => setConfig({...config, llm_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                                <option value="openai">OpenAI (GPT)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Embedding Provider
                            </label>
                            <select
                                value={config.embedding_provider}
                                onChange={e => setConfig({...config, embedding_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="local">Local (Testing)</option>
                                <option value="voyage">Voyage (Code-optimized)</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                    </div>
                    
                    <button
                        onClick={handleInit}
                        disabled={loading}
                        className="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 mb-4"
                    >
                        {loading ? 'Initializing...' : 'Initialize System'}
                    </button>
                    
                    <div className="border-t pt-4">
                        <h3 className="font-medium mb-2">Index Codebase</h3>
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                placeholder="/path/to/codebase"
                                value={dirPath}
                                onChange={e => setDirPath(e.target.value)}
                                className="flex-1 border rounded-md px-3 py-2"
                            />
                            <button
                                onClick={handleIndex}
                                disabled={loading || !dirPath}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400"
                            >
                                Index
                            </button>
                        </div>
                        
                        {indexStats && (
                            <div className="mt-3 p-3 bg-green-50 rounded-md text-sm">
                                ‚úÖ Indexed {indexStats.files} files, {indexStats.units} code units
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        function CodeBlock({ code, language = 'python' }) {
            useEffect(() => {
                hljs.highlightAll();
            }, [code]);
            
            return (
                <div className="code-block">
                    <pre><code className={`language-${language}`}>{code}</code></pre>
                </div>
            );
        }
        
        function SourceResult({ source, index }) {
            const [expanded, setExpanded] = useState(false);
            
            const typeColors = {
                function: 'symbol-function',
                async_function: 'symbol-function',
                class: 'symbol-class',
                method: 'symbol-method',
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-4 mb-3">
                    <div 
                        className="flex items-start justify-between cursor-pointer"
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500 font-mono">#{index + 1}</span>
                            <span className={`symbol-badge ${typeColors[source.type] || 'bg-gray-100'}`}>
                                {source.type}
                            </span>
                            <span className="font-semibold">{source.name}</span>
                        </div>
                        <span className="text-blue-600 font-mono text-sm">
                            {source.score?.toFixed(3)}
                        </span>
                    </div>
                    
                    <div className="mt-2 text-sm text-gray-600">
                        <span className="font-mono">{source.file}:{source.line}</span>
                    </div>
                    
                    {source.signature && (
                        <div className="mt-2 font-mono text-sm bg-gray-100 px-2 py-1 rounded">
                            {source.signature}
                        </div>
                    )}
                    
                    {source.docstring && (
                        <div className="mt-2 text-sm text-gray-700 italic">
                            {source.docstring.substring(0, 150)}...
                        </div>
                    )}
                    
                    {expanded && source.source && (
                        <div className="mt-3">
                            <CodeBlock code={source.source} />
                        </div>
                    )}
                </div>
            );
        }
        
        function QueryPanel({ status }) {
            const [query, setQuery] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [mode, setMode] = useState('query'); // 'query', 'trace', 'symbol'
            const [traceStart, setTraceStart] = useState('');
            const [traceEnd, setTraceEnd] = useState('');
            
            const handleQuery = async () => {
                if (!query || status !== 'ready') return;
                setLoading(true);
                try {
                    const data = await api.query(query);
                    setResult({ type: 'query', data });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            const handleTrace = async () => {
                if (!traceStart || !traceEnd || status !== 'ready') return;
                setLoading(true);
                try {
                    const data = await api.traceFlow(traceStart, traceEnd);
                    setResult({ type: 'trace', data });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            const handleSymbolSearch = async () => {
                if (!query || status !== 'ready') return;
                setLoading(true);
                try {
                    const data = await api.findSymbol(query);
                    setResult({ type: 'symbol', data });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex space-x-4 mb-4">
                            <button
                                onClick={() => setMode('query')}
                                className={`px-4 py-2 rounded-md ${mode === 'query' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}
                            >
                                üí¨ Query
                            </button>
                            <button
                                onClick={() => setMode('trace')}
                                className={`px-4 py-2 rounded-md ${mode === 'trace' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}
                            >
                                üîÑ Trace Flow
                            </button>
                            <button
                                onClick={() => setMode('symbol')}
                                className={`px-4 py-2 rounded-md ${mode === 'symbol' ? 'bg-indigo-600 text-white' : 'bg-gray-200'}`}
                            >
                                üîç Find Symbol
                            </button>
                        </div>
                        
                        {mode === 'query' && (
                            <div className="flex space-x-3">
                                <input
                                    type="text"
                                    placeholder="Ask about the codebase..."
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleQuery()}
                                    className="flex-1 border rounded-md px-4 py-2"
                                />
                                <button
                                    onClick={handleQuery}
                                    disabled={loading || status !== 'ready'}
                                    className="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 disabled:bg-gray-400"
                                >
                                    {loading ? '...' : 'Ask'}
                                </button>
                            </div>
                        )}
                        
                        {mode === 'trace' && (
                            <div className="flex space-x-3 items-center">
                                <input
                                    type="text"
                                    placeholder="Start function"
                                    value={traceStart}
                                    onChange={e => setTraceStart(e.target.value)}
                                    className="flex-1 border rounded-md px-4 py-2"
                                />
                                <span className="text-gray-500">‚Üí</span>
                                <input
                                    type="text"
                                    placeholder="End function"
                                    value={traceEnd}
                                    onChange={e => setTraceEnd(e.target.value)}
                                    className="flex-1 border rounded-md px-4 py-2"
                                />
                                <button
                                    onClick={handleTrace}
                                    disabled={loading || status !== 'ready'}
                                    className="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 disabled:bg-gray-400"
                                >
                                    Trace
                                </button>
                            </div>
                        )}
                        
                        {mode === 'symbol' && (
                            <div className="flex space-x-3">
                                <input
                                    type="text"
                                    placeholder="Symbol name (function, class, etc.)"
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleSymbolSearch()}
                                    className="flex-1 border rounded-md px-4 py-2"
                                />
                                <button
                                    onClick={handleSymbolSearch}
                                    disabled={loading || status !== 'ready'}
                                    className="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 disabled:bg-gray-400"
                                >
                                    Find
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {result && result.type === 'query' && (
                        <div className="space-y-4">
                            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <h3 className="font-medium text-indigo-900 mb-2">Answer</h3>
                                <div className="prose prose-sm max-w-none text-gray-800 whitespace-pre-wrap">
                                    {result.data.answer}
                                </div>
                            </div>
                            
                            <div>
                                <h3 className="font-semibold mb-3">Relevant Code ({result.data.sources?.length || 0})</h3>
                                {result.data.sources?.map((source, i) => (
                                    <SourceResult key={source.id} source={source} index={i} />
                                ))}
                            </div>
                            
                            {result.data.tests?.length > 0 && (
                                <div className="bg-green-50 rounded-lg p-4">
                                    <h3 className="font-medium text-green-900 mb-2">Related Tests</h3>
                                    {result.data.tests.map((test, i) => (
                                        <div key={i} className="text-sm">
                                            <span className="font-mono">{test.name}</span>
                                            <span className="text-gray-500 ml-2">in {test.file}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {result && result.type === 'trace' && (
                        <div className="space-y-4">
                            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <h3 className="font-medium text-indigo-900 mb-2">Code Flow Trace</h3>
                                <div className="prose prose-sm max-w-none text-gray-800 whitespace-pre-wrap">
                                    {result.data.answer}
                                </div>
                            </div>
                            
                            {result.data.flow && (
                                <div className="bg-white rounded-lg shadow-md p-4">
                                    <h3 className="font-semibold mb-3">Execution Flow</h3>
                                    {result.data.flow.map((step, i) => (
                                        <div key={i} className="flow-step">
                                            <div className="font-medium">
                                                Step {step.step}: {step.name}
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {step.type} in {step.file}
                                            </div>
                                            {step.signature && (
                                                <code className="text-sm bg-gray-100 px-1 rounded">
                                                    {step.signature}
                                                </code>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {result && result.type === 'symbol' && (
                        <div className="bg-white rounded-lg shadow-md p-4">
                            <h3 className="font-semibold mb-3">
                                Symbol Results ({result.data.results?.length || 0})
                            </h3>
                            {result.data.results?.map((sym, i) => (
                                <div key={i} className="border-b last:border-0 py-3">
                                    <div className="flex items-center space-x-2">
                                        <span className={`symbol-badge ${
                                            sym.type === 'class' ? 'symbol-class' : 
                                            sym.type === 'method' ? 'symbol-method' : 'symbol-function'
                                        }`}>
                                            {sym.type}
                                        </span>
                                        <span className="font-semibold">{sym.name}</span>
                                    </div>
                                    <div className="text-sm text-gray-600 mt-1 font-mono">
                                        {sym.file}:{sym.line}
                                    </div>
                                    {sym.signature && (
                                        <code className="text-sm block mt-1 bg-gray-100 p-1 rounded">
                                            {sym.signature}
                                        </code>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        function GraphVisualization({ status }) {
            const containerRef = useRef(null);
            const [graphData, setGraphData] = useState(null);
            
            const loadGraph = async () => {
                if (status !== 'ready') return;
                
                try {
                    const data = await api.getGraph();
                    setGraphData(data);
                    
                    if (containerRef.current && data.nodes.length > 0) {
                        const nodes = new vis.DataSet(data.nodes.slice(0, 100).map(n => ({
                            id: n.id,
                            label: n.label,
                            group: n.group,
                            title: `${n.label} (${n.group})`,
                        })));
                        
                        const edges = new vis.DataSet(data.edges.slice(0, 200).map((e, i) => ({
                            id: i,
                            from: e.from,
                            to: e.to,
                            arrows: 'to',
                            color: { opacity: 0.6 },
                        })));
                        
                        const options = {
                            nodes: {
                                shape: 'dot',
                                size: 12,
                                font: { size: 11 },
                            },
                            edges: {
                                smooth: { type: 'curvedCW', roundness: 0.2 },
                            },
                            groups: {
                                file: { color: '#3B82F6' },
                                class: { color: '#8B5CF6' },
                                function: { color: '#10B981' },
                                method: { color: '#F59E0B' },
                            },
                            physics: {
                                stabilization: { iterations: 100 },
                            },
                        };
                        
                        new vis.Network(containerRef.current, { nodes, edges }, options);
                    }
                } catch (err) {
                    console.error('Error loading graph:', err);
                }
            };
            
            useEffect(() => {
                loadGraph();
            }, [status]);
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold">üîó Dependency Graph</h2>
                        <button
                            onClick={loadGraph}
                            className="text-indigo-600 hover:text-indigo-800 text-sm"
                        >
                            Refresh
                        </button>
                    </div>
                    
                    {graphData && (
                        <div className="flex space-x-4 mb-3 text-sm">
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>
                                Files
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-purple-500 mr-1"></span>
                                Classes
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
                                Functions
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-yellow-500 mr-1"></span>
                                Methods
                            </span>
                        </div>
                    )}
                    
                    <div id="graph-container" ref={containerRef}>
                        {!graphData || graphData.nodes.length === 0 ? (
                            <div className="flex items-center justify-center h-full text-gray-500">
                                {status !== 'ready' 
                                    ? 'Initialize and index a codebase to view the graph'
                                    : 'No code indexed yet'
                                }
                            </div>
                        ) : null}
                    </div>
                    
                    {graphData && (
                        <div className="mt-3 text-sm text-gray-500">
                            {graphData.stats?.total_nodes || 0} nodes ‚Ä¢ {graphData.stats?.total_relationships || 0} relationships
                        </div>
                    )}
                </div>
            );
        }
        
        function App() {
            const [status, setStatus] = useState('not_initialized');
            const [activeTab, setActiveTab] = useState('query');
            
            const checkStatus = async () => {
                try {
                    const data = await api.getStatus();
                    setStatus(data.status);
                } catch (err) {
                    console.error('Error:', err);
                }
            };
            
            useEffect(() => {
                checkStatus();
            }, []);
            
            return (
                <div className="min-h-screen">
                    <Header status={status} />
                    
                    <main className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div>
                                <ConfigPanel onInit={checkStatus} />
                            </div>
                            
                            <div className="lg:col-span-2 space-y-6">
                                <div className="flex space-x-4 border-b">
                                    <button
                                        onClick={() => setActiveTab('query')}
                                        className={`pb-2 px-1 ${activeTab === 'query' 
                                            ? 'border-b-2 border-indigo-600 text-indigo-600' 
                                            : 'text-gray-500'}`}
                                    >
                                        üí¨ Query & Trace
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('graph')}
                                        className={`pb-2 px-1 ${activeTab === 'graph' 
                                            ? 'border-b-2 border-indigo-600 text-indigo-600' 
                                            : 'text-gray-500'}`}
                                    >
                                        üîó Dependency Graph
                                    </button>
                                </div>
                                
                                {activeTab === 'query' && <QueryPanel status={status} />}
                                {activeTab === 'graph' && <GraphVisualization status={status} />}
                            </div>
                        </div>
                    </main>
                    
                    <footer className="bg-gray-100 py-4 mt-8">
                        <div className="container mx-auto px-4 text-center text-gray-600 text-sm">
                            Code RAG ‚Ä¢ AST-Aware Codebase Q&A
                        </div>
                    </footer>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
