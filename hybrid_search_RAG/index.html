<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Search RAG</title>
    
    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- vis.js for graph visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/standalone/umd/vis-network.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .search-method-badge {
            @apply px-2 py-1 text-xs rounded-full font-medium;
        }
        .vector-badge { @apply bg-blue-100 text-blue-800; }
        .sparse-badge { @apply bg-green-100 text-green-800; }
        .graph-badge { @apply bg-purple-100 text-purple-800; }
        
        #graph-container {
            width: 100%;
            height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        .score-bar {
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // API Base URL
        const API_BASE = '';
        
        // =================================================================
        // API Functions
        // =================================================================
        
        const api = {
            async init(config) {
                const res = await fetch(`${API_BASE}/api/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });
                return res.json();
            },
            
            async getStatus() {
                const res = await fetch(`${API_BASE}/api/status`);
                return res.json();
            },
            
            async addDocument(doc) {
                const res = await fetch(`${API_BASE}/api/documents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(doc),
                });
                return res.json();
            },
            
            async listDocuments() {
                const res = await fetch(`${API_BASE}/api/documents`);
                return res.json();
            },
            
            async query(question, k = 5) {
                const res = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, k }),
                });
                return res.json();
            },
            
            async compareSearch(question, k = 10) {
                const res = await fetch(`${API_BASE}/api/search/compare`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, k }),
                });
                return res.json();
            },
            
            async getGraph() {
                const res = await fetch(`${API_BASE}/api/graph`);
                return res.json();
            },
        };
        
        // =================================================================
        // Components
        // =================================================================
        
        // Header Component
        function Header({ status }) {
            return (
                <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
                    <div className="container mx-auto px-4 py-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-3xl font-bold">üîç Hybrid Search RAG</h1>
                                <p className="text-blue-100 mt-1">
                                    Vector + BM25 + Knowledge Graph with ML Fusion
                                </p>
                            </div>
                            <div className="flex items-center space-x-4">
                                <span className={`px-3 py-1 rounded-full text-sm ${
                                    status === 'ready' ? 'bg-green-500' : 'bg-yellow-500'
                                }`}>
                                    {status === 'ready' ? '‚óè Ready' : '‚óã Not Initialized'}
                                </span>
                            </div>
                        </div>
                    </div>
                </header>
            );
        }
        
        // Config Panel
        function ConfigPanel({ onInit }) {
            const [config, setConfig] = useState({
                llm_provider: 'anthropic',
                embedding_provider: 'local',
                fusion_strategy: 'rrf',
                enable_vector: true,
                enable_sparse: true,
                enable_graph: true,
            });
            const [loading, setLoading] = useState(false);
            
            const handleInit = async () => {
                setLoading(true);
                try {
                    await api.init(config);
                    onInit();
                } catch (err) {
                    alert('Error initializing: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                LLM Provider
                            </label>
                            <select
                                value={config.llm_provider}
                                onChange={e => setConfig({...config, llm_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                                <option value="openai">OpenAI (GPT)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Embedding Provider
                            </label>
                            <select
                                value={config.embedding_provider}
                                onChange={e => setConfig({...config, embedding_provider: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="local">Local (Testing)</option>
                                <option value="voyage">Voyage AI</option>
                                <option value="openai">OpenAI</option>
                                <option value="google">Google</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Fusion Strategy
                            </label>
                            <select
                                value={config.fusion_strategy}
                                onChange={e => setConfig({...config, fusion_strategy: e.target.value})}
                                className="w-full border rounded-md px-3 py-2"
                            >
                                <option value="rrf">Reciprocal Rank Fusion</option>
                                <option value="weighted">Weighted Combination</option>
                                <option value="learned">Learned Fusion (ML)</option>
                            </select>
                        </div>
                        
                        <div className="flex items-end space-x-4">
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={config.enable_vector}
                                    onChange={e => setConfig({...config, enable_vector: e.target.checked})}
                                    className="mr-2"
                                />
                                Vector
                            </label>
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={config.enable_sparse}
                                    onChange={e => setConfig({...config, enable_sparse: e.target.checked})}
                                    className="mr-2"
                                />
                                BM25
                            </label>
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={config.enable_graph}
                                    onChange={e => setConfig({...config, enable_graph: e.target.checked})}
                                    className="mr-2"
                                />
                                Graph
                            </label>
                        </div>
                    </div>
                    
                    <button
                        onClick={handleInit}
                        disabled={loading}
                        className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                    >
                        {loading ? 'Initializing...' : 'Initialize System'}
                    </button>
                </div>
            );
        }
        
        // Document Panel
        function DocumentPanel({ onUpdate }) {
            const [docId, setDocId] = useState('');
            const [docTitle, setDocTitle] = useState('');
            const [docContent, setDocContent] = useState('');
            const [documents, setDocuments] = useState([]);
            const [loading, setLoading] = useState(false);
            
            useEffect(() => {
                loadDocuments();
            }, []);
            
            const loadDocuments = async () => {
                try {
                    const data = await api.listDocuments();
                    setDocuments(data.documents || []);
                } catch (err) {
                    console.error('Error loading documents:', err);
                }
            };
            
            const handleAdd = async () => {
                if (!docId || !docContent) {
                    alert('Please enter document ID and content');
                    return;
                }
                
                setLoading(true);
                try {
                    await api.addDocument({
                        id: docId,
                        content: docContent,
                        title: docTitle || docId,
                    });
                    setDocId('');
                    setDocTitle('');
                    setDocContent('');
                    loadDocuments();
                    onUpdate();
                } catch (err) {
                    alert('Error adding document: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-semibold mb-4">üìÑ Documents</h2>
                    
                    <div className="space-y-3 mb-4">
                        <div className="grid grid-cols-2 gap-3">
                            <input
                                type="text"
                                placeholder="Document ID"
                                value={docId}
                                onChange={e => setDocId(e.target.value)}
                                className="border rounded-md px-3 py-2"
                            />
                            <input
                                type="text"
                                placeholder="Title (optional)"
                                value={docTitle}
                                onChange={e => setDocTitle(e.target.value)}
                                className="border rounded-md px-3 py-2"
                            />
                        </div>
                        <textarea
                            placeholder="Document content..."
                            value={docContent}
                            onChange={e => setDocContent(e.target.value)}
                            className="w-full border rounded-md px-3 py-2 h-24"
                        />
                        <button
                            onClick={handleAdd}
                            disabled={loading}
                            className="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400"
                        >
                            {loading ? 'Adding...' : 'Add Document'}
                        </button>
                    </div>
                    
                    <div className="border-t pt-4">
                        <h3 className="font-medium mb-2">Indexed Documents ({documents.length})</h3>
                        <div className="space-y-2 max-h-40 overflow-y-auto">
                            {documents.map(doc => (
                                <div key={doc.id} className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                                    <span className="font-medium">{doc.title || doc.id}</span>
                                    <span className="text-gray-500 text-sm">{doc.length} chars</span>
                                </div>
                            ))}
                            {documents.length === 0 && (
                                <p className="text-gray-500 text-sm">No documents indexed yet</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        // Search Result Component
        function SearchResult({ result, index }) {
            const maxScore = Math.max(
                result.vector_score || 0,
                result.sparse_score || 0,
                result.graph_score || 0
            );
            
            return (
                <div className="bg-white rounded-lg shadow-md p-4 mb-4">
                    <div className="flex items-start justify-between mb-2">
                        <div className="flex items-center space-x-2">
                            <span className="bg-gray-200 text-gray-700 px-2 py-1 rounded text-sm font-medium">
                                #{index + 1}
                            </span>
                            <span className="font-medium">{result.id}</span>
                        </div>
                        <span className="text-blue-600 font-semibold">
                            Score: {result.score.toFixed(4)}
                        </span>
                    </div>
                    
                    <p className="text-gray-700 text-sm mb-3 line-clamp-3">
                        {result.content}
                    </p>
                    
                    <div className="flex items-center space-x-2 mb-3">
                        {result.methods.map(method => (
                            <span key={method} className={`search-method-badge ${method}-badge`}>
                                {method === 'vector' && 'üéØ Vector'}
                                {method === 'sparse' && 'üìù BM25'}
                                {method === 'graph' && 'üîó Graph'}
                            </span>
                        ))}
                    </div>
                    
                    <div className="space-y-1">
                        {result.vector_score !== null && (
                            <div className="flex items-center">
                                <span className="text-xs w-16 text-gray-500">Vector:</span>
                                <div className="flex-1 bg-gray-100 rounded-full h-1">
                                    <div 
                                        className="score-bar bg-blue-500"
                                        style={{ width: `${(result.vector_score / maxScore) * 100}%` }}
                                    />
                                </div>
                                <span className="text-xs w-16 text-right">{result.vector_score?.toFixed(3)}</span>
                            </div>
                        )}
                        {result.sparse_score !== null && (
                            <div className="flex items-center">
                                <span className="text-xs w-16 text-gray-500">BM25:</span>
                                <div className="flex-1 bg-gray-100 rounded-full h-1">
                                    <div 
                                        className="score-bar bg-green-500"
                                        style={{ width: `${(result.sparse_score / maxScore) * 100}%` }}
                                    />
                                </div>
                                <span className="text-xs w-16 text-right">{result.sparse_score?.toFixed(3)}</span>
                            </div>
                        )}
                        {result.graph_score !== null && (
                            <div className="flex items-center">
                                <span className="text-xs w-16 text-gray-500">Graph:</span>
                                <div className="flex-1 bg-gray-100 rounded-full h-1">
                                    <div 
                                        className="score-bar bg-purple-500"
                                        style={{ width: `${(result.graph_score / maxScore) * 100}%` }}
                                    />
                                </div>
                                <span className="text-xs w-16 text-right">{result.graph_score?.toFixed(3)}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // Query Panel
        function QueryPanel({ status }) {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState(null);
            const [answer, setAnswer] = useState('');
            const [loading, setLoading] = useState(false);
            const [k, setK] = useState(5);
            
            const handleQuery = async () => {
                if (!query) return;
                if (status !== 'ready') {
                    alert('Please initialize the system first');
                    return;
                }
                
                setLoading(true);
                setAnswer('');
                setResults(null);
                
                try {
                    const data = await api.query(query, k);
                    setAnswer(data.answer);
                    setResults(data);
                } catch (err) {
                    alert('Error querying: ' + err.message);
                }
                setLoading(false);
            };
            
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-semibold mb-4">üí¨ Query</h2>
                        
                        <div className="flex space-x-3 mb-4">
                            <input
                                type="text"
                                placeholder="Ask a question about your documents..."
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleQuery()}
                                className="flex-1 border rounded-md px-4 py-2"
                            />
                            <select
                                value={k}
                                onChange={e => setK(parseInt(e.target.value))}
                                className="border rounded-md px-3"
                            >
                                {[3, 5, 10, 20].map(n => (
                                    <option key={n} value={n}>Top {n}</option>
                                ))}
                            </select>
                            <button
                                onClick={handleQuery}
                                disabled={loading || status !== 'ready'}
                                className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {loading ? '...' : 'Search'}
                            </button>
                        </div>
                        
                        {answer && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="font-medium text-blue-900 mb-2">Answer</h3>
                                <p className="text-gray-800 whitespace-pre-wrap">{answer}</p>
                            </div>
                        )}
                    </div>
                    
                    {results && (
                        <div>
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-lg font-semibold">
                                    Search Results ({results.sources.length})
                                </h3>
                                <div className="text-sm text-gray-500">
                                    Vector: {results.stats.vector_count} | 
                                    BM25: {results.stats.sparse_count} | 
                                    Graph: {results.stats.graph_count}
                                </div>
                            </div>
                            
                            {results.sources.map((result, i) => (
                                <SearchResult key={result.id} result={result} index={i} />
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        // Knowledge Graph Visualization
        function GraphVisualization({ status }) {
            const containerRef = useRef(null);
            const [graphData, setGraphData] = useState(null);
            
            const loadGraph = async () => {
                if (status !== 'ready') return;
                
                try {
                    const data = await api.getGraph();
                    setGraphData(data);
                    
                    if (containerRef.current && data.nodes.length > 0) {
                        const nodes = new vis.DataSet(data.nodes.map(n => ({
                            id: n.id,
                            label: n.label,
                            group: n.group,
                            title: `${n.label} (${n.group})`,
                        })));
                        
                        const edges = new vis.DataSet(data.edges.map((e, i) => ({
                            id: i,
                            from: e.from,
                            to: e.to,
                            label: e.label,
                            arrows: 'to',
                        })));
                        
                        const options = {
                            nodes: {
                                shape: 'dot',
                                size: 16,
                                font: { size: 12 },
                            },
                            edges: {
                                font: { size: 10, align: 'middle' },
                                smooth: { type: 'curvedCW' },
                            },
                            groups: {
                                document: { color: '#3B82F6' },
                                person: { color: '#EF4444' },
                                organization: { color: '#10B981' },
                                concept: { color: '#8B5CF6' },
                                other: { color: '#6B7280' },
                            },
                            physics: {
                                enabled: true,
                                solver: 'forceAtlas2Based',
                            },
                        };
                        
                        new vis.Network(containerRef.current, { nodes, edges }, options);
                    }
                } catch (err) {
                    console.error('Error loading graph:', err);
                }
            };
            
            useEffect(() => {
                loadGraph();
            }, [status]);
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold">üîó Knowledge Graph</h2>
                        <button
                            onClick={loadGraph}
                            className="text-blue-600 hover:text-blue-800 text-sm"
                        >
                            Refresh
                        </button>
                    </div>
                    
                    {graphData && (
                        <div className="flex space-x-4 mb-3 text-sm">
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>
                                Documents
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-red-500 mr-1"></span>
                                People
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
                                Organizations
                            </span>
                            <span className="flex items-center">
                                <span className="w-3 h-3 rounded-full bg-purple-500 mr-1"></span>
                                Concepts
                            </span>
                        </div>
                    )}
                    
                    <div id="graph-container" ref={containerRef}>
                        {!graphData || graphData.nodes.length === 0 ? (
                            <div className="flex items-center justify-center h-full text-gray-500">
                                {status !== 'ready' 
                                    ? 'Initialize system to view graph'
                                    : 'No entities in graph. Add documents to populate.'
                                }
                            </div>
                        ) : null}
                    </div>
                    
                    {graphData && (
                        <div className="mt-3 text-sm text-gray-500">
                            {graphData.stats.entities} entities ‚Ä¢ {graphData.stats.relations} relations
                        </div>
                    )}
                </div>
            );
        }
        
        // Main App Component
        function App() {
            const [status, setStatus] = useState('not_initialized');
            const [activeTab, setActiveTab] = useState('query');
            
            const checkStatus = async () => {
                try {
                    const data = await api.getStatus();
                    setStatus(data.status);
                } catch (err) {
                    console.error('Error checking status:', err);
                }
            };
            
            useEffect(() => {
                checkStatus();
            }, []);
            
            return (
                <div className="min-h-screen">
                    <Header status={status} />
                    
                    <main className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Panel - Config & Documents */}
                            <div className="space-y-6">
                                <ConfigPanel onInit={checkStatus} />
                                <DocumentPanel onUpdate={checkStatus} />
                            </div>
                            
                            {/* Middle/Right Panel - Query & Results */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* Tabs */}
                                <div className="flex space-x-4 border-b">
                                    <button
                                        onClick={() => setActiveTab('query')}
                                        className={`pb-2 px-1 ${activeTab === 'query' 
                                            ? 'border-b-2 border-blue-600 text-blue-600' 
                                            : 'text-gray-500'}`}
                                    >
                                        üí¨ Query
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('graph')}
                                        className={`pb-2 px-1 ${activeTab === 'graph' 
                                            ? 'border-b-2 border-blue-600 text-blue-600' 
                                            : 'text-gray-500'}`}
                                    >
                                        üîó Knowledge Graph
                                    </button>
                                </div>
                                
                                {activeTab === 'query' && <QueryPanel status={status} />}
                                {activeTab === 'graph' && <GraphVisualization status={status} />}
                            </div>
                        </div>
                    </main>
                    
                    <footer className="bg-gray-100 py-4 mt-8">
                        <div className="container mx-auto px-4 text-center text-gray-600 text-sm">
                            Hybrid Search RAG ‚Ä¢ Vector + BM25 + Knowledge Graph
                        </div>
                    </footer>
                </div>
            );
        }
        
        // Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
